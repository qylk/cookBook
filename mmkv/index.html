<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>MMKV - 小黑屋</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "MMKV";
    var mkdocs_page_input_path = "mmkv.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> 小黑屋</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">首页</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Android</span>
    <ul class="subnav">
                <li class="">
                    
    <span class="caption-text">编译/脚本</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../annotation/">Annotation注解处理器</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../annotation_debug/">注解处理器调试</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../android_flavor/">Android渠道写入方式</a>
                </li>
    </ul>
                </li>
                <li class=" current">
                    
    <span class="caption-text">框架</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../glide/">Glide</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../lightKV/">lightKV</a>
                </li>
                <li class="toctree-l3 current">
                    
    <a class="current" href="./">MMKV</a>
    <ul class="subnav">
            
    <li class="toctree-l4"><a href="#_1">概念：</a></li>
    

    <li class="toctree-l4"><a href="#_2">开源地址：</a></li>
    

    <li class="toctree-l4"><a href="#_3">原理分析：</a></li>
    

    <li class="toctree-l4"><a href="#_4">源码解析：</a></li>
    

    </ul>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../eventbus/">EventBus</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../okhttp/">OkHttp</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../okhttp_dns/">OkHttp-Dns</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../okhttp_retry/">Okhttp重试机制</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../blockCanary/">BlockCanary</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../leakCanary/">LeakCanary</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">系统分析</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../strictMode/">StrictMode</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../touchEventDispatch/">触摸事件分发</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Webview</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../webview_cache/">缓存机制</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../webview_native/">和Native通信</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../webview_bug/">漏洞</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../webview_optmize/">优化</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">代码片段</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../code/bubble_view/">微信气泡</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../zbar/">zbar</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">适配</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../dev_compat/">系统适配</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">多媒体</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../renderscript/">RenderScript</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">安全</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../android_safe/">建议</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../android_danger/">风险点</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">工具</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../adb_input/">adb模拟屏幕触摸</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../tcpdump/">tcpdump</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">热修复</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../transform.md">Transform</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../classloader/">ClassLoader</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../instantRun/">Instant Run</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../robust/">Robust</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../hotFix/">热修复方案</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../asm/">ASM</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">未分类</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../keepAlive/">应用保活</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">性能优化</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../bitmap/">Bitmap</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../anr/">Anr</a>
                </li>
    </ul>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">网络</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../sni/">SNI</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">工具</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../ffmpeg/">FFMPEG</a>
                </li>
                <li class="">
                    
    <a class="" href="../dmg/">DMG</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Java</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../mmap/">内存映射</a>
                </li>
                <li class="">
                    
    <a class="" href="../java_poet/">JavaPoet</a>
                </li>
                <li class="">
                    
    <a class="" href="../volatile/">Volatile</a>
                </li>
                <li class="">
                    
    <a class="" href="../aspectJ/">AspectJ</a>
                </li>
                <li class="">
                    
    <a class="" href="../java_collections/">Collections</a>
                </li>
                <li class="">
                    
    <a class="" href="../class_access/">access$xxx</a>
                </li>
                <li class="">
                    
    <span class="caption-text">Concurrent</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../volatile/">volatile</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../threadPool/">线程池</a>
                </li>
                <li class="">
                    
    <a class="" href="../java_generic/">泛型通配符</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">虚拟机</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../jvm/">内存模型</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../bookmark/">收藏</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">小黑屋</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>框架 &raquo;</li>
        
      
        
          <li>Android &raquo;</li>
        
      
    
    <li>MMKV</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="_1">概念：</h1>
<p>MMKV 是腾讯基于mmap内存映射的key-value组件，底层序列化/反序列化使用 protobuf 实现，性能高，稳定性强。功能上类似于ios上的NSUserDefaults或者android上的sharedPreference。</p>
<p>另外MMKV还支持加密存储、多进程共享。</p>
<h1 id="_2">开源地址：</h1>
<p>https://github.com/tencent/mmkv</p>
<p>基本介绍：</p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzAwNDY1ODY2OQ==&amp;mid=2649286834&amp;idx=1&amp;sn=b58ec3323f415c36a8611079cae43d12&amp;chksm=8334cc30b443452625f103b06667ba999c4c8cb8dc9ff7a7991ff2bd00c9748796d99eddd54f&amp;scene=21#wechat_redirect">MMKV--基于 mmap 的 iOS 高性能通用 key-value 组件</a></p>
<h1 id="_3">原理分析：</h1>
<h1 id="_4">源码解析：</h1>
<p>1、初始化：</p>
<pre><code class="java">//MMKV初始化入口
MMKV.initialize(this)
</code></pre>

<pre><code class="java">public static String initialize(Context context) {
        rootDir = context.getFilesDir().getAbsolutePath() + &quot;/mmkv&quot;;//工作目录，用于mmap映射的文件的根目录
        initialize(rootDir);//jni调用
        return rootDir;
}
</code></pre>

<pre><code class="java">Java_com_tencent_mmkv_MMKV_initialize(JNIEnv *env, jobject obj, jstring rootDir) {
    if (!rootDir) {
        return;
    }
    const char *kstr = env-&gt;GetStringUTFChars(rootDir, nullptr);
    if (kstr) {
        MMKV::initializeMMKV(kstr);//c++层初始化
        env-&gt;ReleaseStringUTFChars(rootDir, kstr);
    }
}
</code></pre>

<pre><code class="c++">void MMKV::initializeMMKV(const std::string &amp;rootDir) {
    static pthread_once_t once_control = PTHREAD_ONCE_INIT;
    pthread_once(&amp;once_control, initialize);//使用pthread_once保证只初始化一次，初始化工作在指定的第二个参数initialize方法中

    g_rootDir = rootDir;
    char *path = strdup(g_rootDir.c_str());
    mkPath(path);//生成工作目录
    free(path);
}

//一次初始化调用
void initialize() {
    //堆内存上分配map数据结构，key是mmapID，value是MMKV实例指针，用于保存所有的MMKV数据。
    //mmapID相当于一个sharedPreference的文件名，MMKV相当于一个sharedPreference实例。
    g_instanceDic = new unordered_map&lt;std::string, MMKV *&gt;;
    g_instanceLock = ThreadLock();//线程锁
}
</code></pre>

<p>2、实例化MMKV:</p>
<pre><code class="java">/**
mmapID: 字符串型名字，随便起，只要不包含特殊字符
mode: 模式，可组合模式：
   SINGLE_PROCESS_MODE：单进程
   MULTI_PROCESS_MODE：多进程共享模式
   ASHMEM_MODE：匿名共享内存模式，默认是mmap方式的内存共享
cryptKey: 加密key   
*/
MMKV kv = MMKV.mmkvWithID(mmapID, mode, cryptKey);
</code></pre>

<pre><code class="java">public static MMKV mmkvWithID(String mmapID, int mode, String cryptKey) {
        if (rootDir == null) {
            throw new IllegalStateException(&quot;You should Call MMKV.initialize() first.&quot;);
        } else {
            verifyMMID(mmapID);//检查id字符的合法性
            //jni调用获取一个C层的MMKV对象句柄(可以理解为对象指针)，这个句柄用于java层的MMKV对象访问C层的mmkv对象。
            long handle = getMMKVWithID(mmapID, mode, cryptKey);
            return new MMKV(handle);
        }
}
</code></pre>

<pre><code class="c++">const int DEFAULT_MMAP_SIZE = getpagesize();//默认的mmap长度 = 一个页面大小（32位系统中通常是4k字节）

extern &quot;C&quot; JNIEXPORT JNICALL jlong Java_com_tencent_mmkv_MMKV_getMMKVWithID(
    JNIEnv *env, jobject obj, jstring mmapID, jint mode, jstring cryptKey) {

    MMKV *kv = nullptr;
    if (!mmapID) {
        return (jlong) kv;
    }
    string str = jstring2string(env, mmapID);

    if (cryptKey != nullptr) {
        string crypt = jstring2string(env, cryptKey);
        if (crypt.length() &gt; 0) {//使用加密模式
            //调用mmkvWithID方法new一个MMKV对象
            kv = MMKV::mmkvWithID(str, DEFAULT_MMAP_SIZE, (MMKVMode) mode, &amp;crypt);
        }
    }
    if (!kv) {
        kv = MMKV::mmkvWithID(str, DEFAULT_MMAP_SIZE, (MMKVMode) mode, nullptr);//无加密模式
    }

    return (jlong) kv;
}
</code></pre>

<pre><code class="c++">MMKV *MMKV::mmkvWithID(const std::string &amp;mmapID, int size, MMKVMode mode, string *cryptKey) {
    ...
    auto itr = g_instanceDic-&gt;find(mmapID);//根据mmapId从map中查找
    if (itr != g_instanceDic-&gt;end()) {//找到了
        MMKV *kv = itr-&gt;second;
        return kv;//返回mmkv实例对象指针
    }
    auto kv = new MMKV(mmapID, size, mode, cryptKey);//没找到，new一个MMKV
    (*g_instanceDic)[mmapID] = kv;//存到map中，下次就能找到了
    return kv;//返回mmkv实例对象指针
}
</code></pre>

<pre><code class="c++">MMKV::MMKV(const std::string &amp;mmapID, int size, MMKVMode mode, string *cryptKey)
    : m_mmapID(mmapID)//mmapId
    , m_path(mappedKVPathWithID(m_mmapID, mode))//mmap映射文件路径
    , m_crcPath(crcPathWithID(m_mmapID, mode))//crc文件路径
    , m_metaFile(m_crcPath, DEFAULT_MMAP_SIZE, (mode &amp; MMKV_ASHMEM) ? MMAP_ASHMEM : MMAP_FILE)//meta数据结构存储一些基本信息
    , m_crypter(nullptr)//加密器
    , m_fileLock(m_metaFile.getFd())//文件锁
    , m_sharedProcessLock(&amp;m_fileLock, SharedLockType)
    , m_exclusiveProcessLock(&amp;m_fileLock, ExclusiveLockType)
    , m_isInterProcess((mode &amp; MMKV_MULTI_PROCESS) != 0)//多进程模式
    , m_isAshmem((mode &amp; MMKV_ASHMEM) != 0) {//是否是匿名共享内存模式
    m_fd = -1;
    m_ptr = nullptr;
    m_size = 0;
    m_actualSize = 0;
    m_output = nullptr;

    if (m_isAshmem) {
        m_ashmemFile = new MmapedFile(m_mmapID, static_cast&lt;size_t&gt;(size), MMAP_ASHMEM);//打开匿名共享内存
        m_fd = m_ashmemFile-&gt;getFd();
    } else {
        m_ashmemFile = nullptr;
    }

    if (cryptKey &amp;&amp; cryptKey-&gt;length() &gt; 0) {
        m_crypter = new AESCrypt((const unsigned char *) cryptKey-&gt;data(), cryptKey-&gt;length());//初始化加密器
    }

    m_needLoadFromFile = true;

    m_crcDigest = 0;

    m_sharedProcessLock.m_enable = m_isInterProcess;
    m_exclusiveProcessLock.m_enable = m_isInterProcess;

    // sensitive zone
    {
        SCOPEDLOCK(m_sharedProcessLock);
        loadFromFile();
    }
}
</code></pre>

<pre><code class="c++">//m_metaFile是MmapedFile类型的，path是crc文件，构造函数：
MmapedFile::MmapedFile(const std::string &amp;path, size_t size, bool fileType)
    : m_name(path), m_fd(-1), m_segmentPtr(nullptr), m_segmentSize(0), m_fileType(fileType) {
    if (m_fileType == MMAP_FILE) {//mmap模式
        m_fd = open(m_name.c_str(), O_RDWR | O_CREAT, S_IRWXU);//读写模式打开文件
        if (m_fd &lt; 0) {
            MMKVError(&quot;fail to open:%s, %s&quot;, m_name.c_str(), strerror(errno));
        } else {
            struct stat st = {};
            if (fstat(m_fd, &amp;st) != -1) {
                m_segmentSize = static_cast&lt;size_t&gt;(st.st_size);
            }
            if (m_segmentSize &lt; DEFAULT_MMAP_SIZE) {
                m_segmentSize = static_cast&lt;size_t&gt;(DEFAULT_MMAP_SIZE);
                //ftruncate将crc文件大小调整为DEFAULT_MMAP_SIZE大小
                if (ftruncate(m_fd, m_segmentSize) != 0 || !zeroFillFile(m_fd, 0, m_segmentSize)) {
                    MMKVError(&quot;fail to truncate [%s] to size %zu, %s&quot;, m_name.c_str(),
                              m_segmentSize, strerror(errno));
                    close(m_fd);
                    m_fd = -1;
                    removeFile(m_name);
                    return;
                }
            }
            //调用mmap映射crc文件到内存
            m_segmentPtr =
                (char *) mmap(nullptr, m_segmentSize, PROT_READ | PROT_WRITE, MAP_SHARED, m_fd, 0);
            if (m_segmentPtr == MAP_FAILED) {
                MMKVError(&quot;fail to mmap [%s], %s&quot;, m_name.c_str(), strerror(errno));
                close(m_fd);
                m_fd = -1;
                m_segmentPtr = nullptr;
            }
        }
    } else {//ashmem模式
        m_fd = open(ASHMEM_NAME_DEF, O_RDWR);
        if (m_fd &lt; 0) {
            MMKVError(&quot;fail to open ashmem:%s, %s&quot;, m_name.c_str(), strerror(errno));
        } else {
            if (ioctl(m_fd, ASHMEM_SET_NAME, m_name.c_str()) != 0) {
                MMKVError(&quot;fail to set ashmem name:%s, %s&quot;, m_name.c_str(), strerror(errno));
            } else if (ioctl(m_fd, ASHMEM_SET_SIZE, size) != 0) {
                MMKVError(&quot;fail to set ashmem:%s, size %d, %s&quot;, m_name.c_str(), size,
                          strerror(errno));
            } else {
                m_segmentSize = static_cast&lt;size_t&gt;(size);
                m_segmentPtr = (char *) mmap(nullptr, m_segmentSize, PROT_READ | PROT_WRITE,
                                             MAP_SHARED, m_fd, 0);
                if (m_segmentPtr == MAP_FAILED) {
                    MMKVError(&quot;fail to mmap [%s], %s&quot;, m_name.c_str(), strerror(errno));
                    m_segmentPtr = nullptr;
                } else {
                    return;
                }
            }
            close(m_fd);
            m_fd = -1;
        }
    }
}
</code></pre>

<pre><code class="c++">void MMKV::loadFromFile() {
    if (m_isAshmem) {
        loadFromAshmem();
        return;
    }

    m_metaInfo.read(m_metaFile.getMemory());

    m_fd = open(m_path.c_str(), O_RDWR | O_CREAT, S_IRWXU);//打开mmkv数据文件
    if (m_fd &lt; 0) {
        MMKVError(&quot;fail to open:%s, %s&quot;, m_path.c_str(), strerror(errno));
    } else {
        m_size = 0;
        struct stat st = {0};
        if (fstat(m_fd, &amp;st) != -1) {
            m_size = static_cast&lt;size_t&gt;(st.st_size);
        }
        // round up to (n * pagesize)
        if (m_size &lt; DEFAULT_MMAP_SIZE || (m_size % DEFAULT_MMAP_SIZE != 0)) {
            size_t oldSize = m_size;
            m_size = ((m_size / DEFAULT_MMAP_SIZE) + 1) * DEFAULT_MMAP_SIZE;
            if (ftruncate(m_fd, m_size) != 0) {//将文件大小调整为n*pagesize
                MMKVError(&quot;fail to truncate [%s] to size %zu, %s&quot;, m_mmapID.c_str(), m_size,
                          strerror(errno));
                m_size = static_cast&lt;size_t&gt;(st.st_size);
            }
            zeroFillFile(m_fd, oldSize, m_size - oldSize);//用0填充剩余空间
        }
        //调用mmap映射数据文件到内存
        m_ptr = (char *) mmap(nullptr, m_size, PROT_READ | PROT_WRITE, MAP_SHARED, m_fd, 0);
        if (m_ptr == MAP_FAILED) {
            MMKVError(&quot;fail to mmap [%s], %s&quot;, m_mmapID.c_str(), strerror(errno));
        } else {
            memcpy(&amp;m_actualSize, m_ptr, Fixed32Size);//提取前4个字节：数据长度
            MMKVInfo(&quot;loading [%s] with %zu size in total, file size is %zu&quot;, m_mmapID.c_str(),
                     m_actualSize, m_size);
            bool loaded = false;
            if (m_actualSize &gt; 0) {
                if (m_actualSize &lt; m_size &amp;&amp; m_actualSize + Fixed32Size &lt;= m_size) {
                    if (checkFileCRCValid()) {//校验crc文件
                        MMKVInfo(&quot;loading [%s] with crc %u sequence %u&quot;, m_mmapID.c_str(),
                                 m_metaInfo.m_crcDigest, m_metaInfo.m_sequence);
                        MMBuffer inputBuffer(m_ptr + Fixed32Size, m_actualSize, MMBufferNoCopy);//将所有数据加载到buffer中，非拷贝模式
                        if (m_crypter) {
                            decryptBuffer(*m_crypter, inputBuffer);//数据解密
                        }
                        m_dic = MiniPBCoder::decodeMap(inputBuffer);//protobuf解码成数据map
                        m_output = new CodedOutputData(m_ptr + Fixed32Size + m_actualSize,
                                                       m_size - Fixed32Size - m_actualSize);//构造数据写入类，以后使用m_output来写入数据
                        loaded = true;
                    }
                }
            }
            if (!loaded) {
                SCOPEDLOCK(m_exclusiveProcessLock);

                if (m_actualSize &gt; 0) {
                    writeAcutalSize(0);
                }
                m_output = new CodedOutputData(m_ptr + Fixed32Size, m_size - Fixed32Size);
                recaculateCRCDigest();
            }
            MMKVInfo(&quot;loaded [%s] with %zu values&quot;, m_mmapID.c_str(), m_dic.size());
        }
    }

    if (!isFileValid()) {
        MMKVWarning(&quot;[%s] file not valid&quot;, m_mmapID.c_str());
    }

    m_needLoadFromFile = false;
}
</code></pre>

<p>3、数据写入：</p>
<p>//todo</p>
<p>4、数据读取：</p>
<p>//todo</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../eventbus/" class="btn btn-neutral float-right" title="EventBus">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../lightKV/" class="btn btn-neutral" title="lightKV"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../lightKV/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../eventbus/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
