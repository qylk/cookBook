<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>缓存机制 - 小黑屋</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "\u7f13\u5b58\u673a\u5236";
    var mkdocs_page_input_path = "webview_cache.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> 小黑屋</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">首页</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Android</span>
    <ul class="subnav">
                <li class="">
                    
    <span class="caption-text">编译/脚本</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../annotation/">Annotation注解处理器</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../annotation_debug/">注解处理器调试</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../android_flavor/">Android渠道写入方式</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">框架</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../glide/">Glide</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../lightKV/">lightKV</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../mmkv/">MMKV</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../eventbus/">EventBus</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../okhttp/">OkHttp</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../okhttp_dns/">OkHttp-Dns</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../okhttp_retry/">Okhttp重试机制</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../blockCanary/">BlockCanary</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../leakCanary/">LeakCanary</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">系统分析</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../strictMode/">StrictMode</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../touchEventDispatch/">触摸事件分发</a>
                </li>
    </ul>
                </li>
                <li class=" current">
                    
    <span class="caption-text">Webview</span>
    <ul class="subnav">
                <li class="toctree-l3 current">
                    
    <a class="current" href="./">缓存机制</a>
    <ul class="subnav">
            
    <li class="toctree-l4"><a href="#_1">第一种：浏览器缓存机制</a></li>
    

    <li class="toctree-l4"><a href="#application-cache">第二种：APPlication Cache</a></li>
    

    <li class="toctree-l4"><a href="#dom-storage">第三种 Dom Storage</a></li>
    

    <li class="toctree-l4"><a href="#web-sql-database">第四种 Web Sql Database</a></li>
    

    <li class="toctree-l4"><a href="#indexed-database">第五种 Indexed Database</a></li>
    

    <li class="toctree-l4"><a href="#file-system">第六种 File System</a></li>
    

    </ul>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../webview_native/">和Native通信</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../webview_bug/">漏洞</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../webview_optmize/">优化</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">代码片段</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../code/bubble_view/">微信气泡</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../zbar/">zbar</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">适配</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../dev_compat/">系统适配</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">多媒体</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../renderscript/">RenderScript</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">安全</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../android_safe/">建议</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../android_danger/">风险点</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">工具</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../adb_input/">adb模拟屏幕触摸</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../tcpdump/">tcpdump</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">热修复</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../transform/">Transform</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../classloader/">ClassLoader</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../instantRun/">Instant Run</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../robust/">Robust</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../hotFix/">热修复方案</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../asm/">ASM</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">未分类</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../keepAlive/">应用保活</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">性能优化</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../bitmap/">Bitmap</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../anr/">Anr</a>
                </li>
    </ul>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">网络</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../sni/">SNI</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">工具</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../ffmpeg/">FFMPEG</a>
                </li>
                <li class="">
                    
    <a class="" href="../dmg/">DMG</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Java</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../mmap/">内存映射</a>
                </li>
                <li class="">
                    
    <a class="" href="../java_poet/">JavaPoet</a>
                </li>
                <li class="">
                    
    <a class="" href="../volatile/">Volatile</a>
                </li>
                <li class="">
                    
    <a class="" href="../aspectJ/">AspectJ</a>
                </li>
                <li class="">
                    
    <a class="" href="../java_collections/">Collections</a>
                </li>
                <li class="">
                    
    <a class="" href="../class_access/">access$xxx</a>
                </li>
                <li class="">
                    
    <span class="caption-text">Concurrent</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../volatile/">volatile</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../threadPool/">线程池</a>
                </li>
                <li class="">
                    
    <a class="" href="../java_generic/">泛型通配符</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">虚拟机</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../jvm/">内存模型</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../bookmark/">收藏</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">小黑屋</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Webview &raquo;</li>
        
      
        
          <li>Android &raquo;</li>
        
      
    
    <li>缓存机制</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <p><strong>Webview自带的缓存机制主要有以下几种:</strong></p>
<pre><code>浏览器缓存
APPlication Cache
Dom Storage
Web Sql Database
Indexed Database
File System
</code></pre>
<hr />
<h3 id="_1">第一种：浏览器缓存机制</h3>
<p>这个协议主要是前端同学设置，原理是：</p>
<p>根据 HTTP 协议头里的 Cache-Control （或 Expires）和 Last-Modified（或 Etag）等字段来控制客户端浏览器的文件缓存机制</p>
<ul>
<li>
<p>Cache-Control ：用于控制文件在本地缓存有效时长</p>
<p>Cache-Control:max-age=600 
表示文件在本地应该缓存，且有效时长是600秒（从发出请求算起）。在接下来600秒内，如果有请求这个资源，浏览器不会发出 HTTP 请求，而是直接使用本地缓存的文件</p>
</li>
<li>
<p>Expires ：与Cache-Control功能相同，即控制缓存的有效时间</p>
<p>Expires:Tue,12 Jun 2018 16:39:54 GMT 
Expires是 HTTP1.0 标准中的字段，Cache-Control 是 HTTP1.1 标准中新加的字段，当这两个字段同时出现时，Cache-Control 优先级较高</p>
</li>
<li>
<p>Last-Modified ：标识文件在服务器上的最新更新时间</p>
<p>Last-Modified:Tue,12 Jun 2018 16:39:54 GMT 这表示文件最后的修改时间 
在下次请求的时候，如果这个时间已经超过了上面这个字段的时间，浏览器通过 If-Modified-Since 字段带上这个时间，发送给服务器，由服务器比较时间戳来判断文件是否有修改。如果没有修改，服务器返回304告诉浏览器继续使用缓存；如果有修改，则返回200，同时返回最新的文件。</p>
</li>
<li>
<p>Etag ：功能同Last-Modified ，即标识文件在服务器上的最新更新时间</p>
<p>ETag:"10df8c5f-110" Etag 取值是一个对文件进行标识的特征字串 
在向服务器查询文件是否有更新时，浏览器通过If-None-Match 字段把特征字串发送给服务器，由服务器和文件最新特征字串进行匹配，来判断文件是否有更新：没有更新回包304，有更新回包200</p>
</li>
</ul>
<p>归根结底就是用2个字段，一个用于控制缓存有效时间，一个用于在缓存失效后，向服务查询是否有更新。</p>
<p>特别注意：浏览器缓存机制是浏览器内核的机制，一般都是标准的实现</p>
<p><img alt="cache" src="../assets/16.webp" /></p>
<hr />
<h3 id="application-cache">第二种：APPlication Cache</h3>
<ul>
<li>以文件为单位进行缓存，且文件有一定更新机制（是对浏览器缓存机制的补充, 原理相似）</li>
<li>是一个专门为Web App离线使用的缓存机制</li>
<li>AppCache 的缓存文件与浏览器的缓存文件是分开存储的，因为 AppCache 在本地有5MB的空间限制</li>
</ul>
<p>前端在文档的 html 标记中添加 manifest 属性指定配置文件:</p>
<pre><code class="html">&lt;!--https://域名/cache.manifest--&gt; 
&lt;html manifest=&quot;/cache.manifest&quot;&gt; 
  ... 
&lt;/html&gt; 
</code></pre>

<p>一个典型的manifest文件格式，包含三部分配置：</p>
<pre><code>    CACHE MANIFEST - 在此标题下列出的文件将在首次下载后进行缓存
    NETWORK - 在此标题下列出的文件需要与服务器的连接，且不会被缓存
    FALLBACK - 在此标题下列出的文件规定当页面无法访问时的回退页面（比如 404 页面）
</code></pre>
<p>格式举例：</p>
<pre><code>CACHE MANIFEST 

## 注释：需要缓存的文件，无论在线与否，均从缓存里读取
CACHE:
chched.js
cached.css

# 注释：不缓存的文件，无论缓存中存在与否，均从新获取
NETWORK:
uncached.js
uncached.css

# 注释：获取不到资源时的备选路径，如index.html访问失败，则返回404页面
FALLBACK:
index.html 404.html
</code></pre>

<p><img alt="cache" src="../assets/15.png" /></p>
<p><strong>android客户端AppCache缓存目录设置：</strong></p>
<pre><code class="java">//设置缓存目录 
mSetting.setAppCachePath(getCacheDir().getAbsolutePath()); 
//设置是否启用缓存 
mSetting.setAppCacheEnabled(true); 
//设置缓存大小 
mSetting.setAppCacheMaxSize(20*1024*1024); 
</code></pre>

<h3 id="dom-storage">第三种 Dom Storage</h3>
<p>通过存储字符串的 Key - Value 对来提供，该存储机制和服务器没有交互，类似于 Android 的 SharedPreference 存储机制，适合存储临时、简单的数据。提供 5MB（分 HOST)的存储空间。</p>
<ul>
<li>DOM Storage 分为 sessionStorage &amp; localStorage； 二者使用方法基本相同，区别在于作用范围不同： </li>
<li>sessionStorage：具备临时性，即存储与页面相关的数据，它在页面关闭后无法使用 </li>
<li>localStorage：具备持久性，即保存的数据在页面关闭后下次还可以使用</li>
</ul>
<p><strong>android客户端DOM Storage设置：</strong></p>
<pre><code class="java">// 开启DOM storage 
mSetting.setDomStorageEnabled(true); 
</code></pre>

<h3 id="web-sql-database">第四种 Web Sql Database</h3>
<p>原理是基于SQL的数据库存储一些结构性的数据，可以方便对数据进行增删改查，现在主流浏览器 SQL Database 的实现都是基于 SQLite，但这种方式官方已经不推荐使用了，Android webview似乎也不再支持，后续版本不再维护，取而代之的是IndexedDB缓存机制。</p>
<p><strong>android客户端Sql Database设置：</strong></p>
<pre><code class="java">mSetting.setDatabaseEnabled(true); 
String dbPath = getDir(&quot;db&quot;, Context.MODE_PRIVATE).getPath(); 
mSetting.setDatabasePath(dbPath); 
</code></pre>

<h3 id="indexed-database">第五种 Indexed Database</h3>
<p>是一种NoSql数据库，也使用key-value的存储方式，相比于dom功能更强大，可以通过数据库的事务机制进行数据操作，支持index(索引)快速查询；存储空间更大，默认推荐250M，比dom的5M大的多了，比较适合复杂，大量的结构化数据存储</p>
<p>Android 4.4 引入 IndexDB 支持，在客户端上只用设置允许js，就自动打开了这种缓存机制</p>
<pre><code class="java">mSetting.setJavaScriptEnabled(true); 
</code></pre>

<h3 id="file-system">第六种 File System</h3>
<p>这种机制是H5新加入的存储机制，原理为H5页面的数据 提供一个虚拟的文件系统，目前Android Webview暂时不支持</p>
<ul>
<li>可进行文件的创建、读、写、删除、遍历等操作，就像 Native App 访问本地文件系统一样</li>
<li>虚拟的文件系统是运行在沙盒中</li>
<li>不同 WebApp 的虚拟文件系统是互相隔离的，虚拟文件系统与本地文件系统也是互相隔离的</li>
</ul>
<p><img alt="cache" src="../assets/17.png" /></p>
<p><strong>android WebView缓存策略配置：</strong></p>
<pre><code>LOAD_CACHE_ONLY：不使用网络，只读取本地缓存数据 
LOAD_DEFAULT：（默认）根据cache-control决定是否从网络上取数据 
LOAD_NO_CACHE：不使用缓存，只从网络获取数据 
LOAD_CACHE_ELSE_NETWORK：只要本地有，无论是否过期，都使用缓存中的数据，本地没有缓存时才从网络获取
</code></pre>
<pre><code class="java">//设置缓存策略
mSetting.setCacheMode(WebSettings.LOAD_DEFAULT);
</code></pre>

<p><strong>android webView缓存路径：</strong></p>
<p><img alt="cache" src="../assets/18.png" /></p>
<p><strong>android webView缓存的清理：</strong></p>
<pre><code class="java">/**
     * Clears the storage currently being used by both the Application Cache and
     * Web SQL Database APIs by the given origin. The origin is specified using
     * its string representation.
     */
    public void deleteOrigin(String origin) {
        // Must be a no-op for backward compatibility: see the hidden constructor for reason.
    }

/**
     * Clears all storage currently being used by the JavaScript storage APIs.
     * This includes the Application Cache, Web SQL Database and the HTML5 Web
     * Storage APIs.
     */
    public void deleteAllData() {
        // Must be a no-op for backward compatibility: see the hidden constructor for reason.
    }
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../webview_native/" class="btn btn-neutral float-right" title="和Native通信">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../touchEventDispatch/" class="btn btn-neutral" title="触摸事件分发"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../touchEventDispatch/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../webview_native/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
